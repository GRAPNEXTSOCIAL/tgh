<!DOCTYPE html>
{% load static %}
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1"
      crossorigin="anonymous"
    />

    <!--Owl Carousel CSS-->
    <link rel="stylesheet" href="{% static 'app/css/owl.carousel.min.css' %}" />

    <!--FontAwesome CSS-->
    <link rel="stylesheet" href="{% static 'app/css/all.min.css' %}" />

    <!--Custom CSS-->
    <link rel="stylesheet" href="{% static 'app/css/style.css' %}" />

    <title>THE GROCERY HOUSE {% block title %} {% endblock title %}</title>
    <!--FontAwesome CSS-->
    <link
      rel="stylesheet"
      href="{% static 'app/assets/libs/flot/css/float-chart.css' %}"
    />

    <!--Custom CSS-->
    <link rel="stylesheet" href="{% static 'app/dist/css/style.min.css' %}" />

    <link href="{% static 'assetss/img/favicon.png' %}" rel="icon">
  <link href="{% static 'assetss/img/apple-touch-icon.png' %}" rel="apple-touch-icon">

  <!-- Google Fonts -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
  <link href="https://fonts.gstatic.com" rel="preconnect">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="{% static 'assetss/vendor/bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
  <link href="{% static 'assetss/vendor/bootstrap-icons/bootstrap-icons.css' %}" rel="stylesheet">
  <link href="{% static 'assetss/vendor/boxicons/css/boxicons.min.css' %}" rel="stylesheet">
  <link href="{% static 'assetss/vendor/quill/quill.snow.css' %}" rel="stylesheet">
  <link href="{% static 'assetss/vendor/quill/quill.bubble.css' %}" rel="stylesheet">
  <link href="{% static 'assetss/vendor/remixicon/remixicon.css' %}" rel="stylesheet">
  <link href="{% static 'assetss/vendor/simple-datatables/style.css' %}" rel="stylesheet">

  <!-- Template Main CSS File -->
  <link href="{% static 'assetss/css/style.css' %}" rel="stylesheet">
  <style>
    svg{
    font-size: 120px;
    padding-top: -50px;
 }
 .copy{
    fill: none;
    stroke: #fff;
    stroke-width: 5px;
    stroke-dasharray: 15% 40%;
    stroke-dashoffset: 0%;
    animation: textanimation 6s linear infinite;
 }
 @keyframes textanimation{
    100%{
        stroke-dashoffset: -35%;
    }
 }
.copy1{
    stroke: green;
    animation-delay: -1s;
 }
.copy2{
    stroke: green;
    animation-delay: -2s;
 }
 .copy3{
    stroke: green;
    animation-delay: -3s;
 }
  .copy4{
    stroke: green;
    animation-delay: -4s;
 }
 .copy5{
    stroke: green;
    animation-delay: -5s;
 }
  </style>
  </head>

  <body>

    <!-- Jquery -->
<script
src="https://code.jquery.com/jquery-3.5.1.min.js"
integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
crossorigin="anonymous"
></script>
<!-- Bootstrap Bundle with Popper -->
<script
src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"
integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW"
crossorigin="anonymous"
></script>
<script src="{% static 'app/js/owl.carousel.min.js' %}"></script>
<script src="{% static 'app/js/all.min.js' %}"></script>
<script src="{% static 'app/js/myscript.js' %}"></script>
    <!-- ======= Header ======= -->
    <header id="header" class="header fixed-top d-flex align-items-center">

      <div class="d-flex align-items-center justify-content-between">
        <a href="{% url 'home' %}" class="logo d-flex align-items-center">
          <img src="{% static 'assetss/img/logo.png' %}" alt="">
          <span class="d-none d-lg-block">THE GROCERY HOUSE</span>
        </a>
        <i class="bi bi-list toggle-sidebar-btn"></i>
      </div><!-- End Logo -->
  
      
      <nav class="header-nav ms-auto">
        <ul class="d-flex align-items-center">
  
          <li class="nav-item d-block d-lg-none">
            <a class="nav-link nav-icon search-bar-toggle " href="#">
              <i class="bi bi-search"></i>
            </a>
          </li><!-- End Search Icon-->
  
          <li class="nav-item dropdown pe-3">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
              {% if request.user.is_authenticated %}
               <li class="nav-item dropdown mx-2">
                  <a class="nav-link dropdown-toggle text-white" href="#" id="profileDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" style="font-weight: bold; text-transform: uppercase;">
                    {{request.user.username|capfirst}}
                  </a>
                  <ul class="dropdown-menu" aria-labelledby="profileDropdown">
                    <li><a class="dropdown-item" href="{% url 'profile' %}">Profile</a></li>                 
                    <li><a class="dropdown-item" href="{% url 'passwordchange' %}">Change Password</a></li>
                    <li><a class="dropdown-item" href="{% url 'logout' %}">Log out</a></li>
                  </ul>
                </li>
             </div>
              {% endif %}
              </ul>       <!-- End Profile Dropdown Items -->
          </li><!-- End Profile Nav -->
  
        </ul>
      </nav><!-- End Icons Navigation -->
  
  </header><!-- End Header -->
    <br><br><br>


    <div class="top" style="margin-left:20px;">
      <div class="row">
        <div class="col-md-3">
              <label for="trans_date"><span style="font-weight: bold;">Trans Date:</label>
              <input type="text" placeholder="YYYY-MM-DD" name="trans_date" style="width:50%;">
              <br>
              <label for=""><span style="font-weight: bold;">Supplier:</label>
              <select name="" id="" style="width: 50%;">
                <option value="">Select Supplier</option>
                  {% for s in supplier_all %}
                    <option value="">{{ s.supplier }}</option>
                  {% endfor %}
              </select>
              <br>
              <label for="bill_type"><span style="font-weight: bold;">Bill Type:</label>
              <select name="" id="" style="width: 50%;">
                <option value="">Select Bill Tax Type</option>
                <option value="">CGST</option>
                <option value="">SGST</option>
                <option value="">IGST</option>
                <option value="">UNREGD</option>
                <option value="">COMPOSITE</option>
              </select>
        </div>
        <div class="col-md-5">
          <div class="row">
            <div class="col-md-6">
              <label for="bill_no"><span style="font-weight: bold;">Bill No:</label>
                  <input type="text" name="bill_no" style="width:50%;">
              <br>
               <label for="ledger_acc"><span style="font-weight: bold;">Ledger a/c:</label>
               <input type="text" name="ledger_acc" style="width: 50%;">
            </div>
            <div class="col-md-6">
              <label for="bill_date"><span style="font-weight: bold;">Bill Date:</label>
              <input type="datetime" placeholder="" name="bill_date" style="width: 50%;">
              <br>
              <label for="gstin"><span style="font-weight: bold;">GSTIN:</label>
              <input type="text" name="gstin" style="width: 50%;">
            </div>
          </div>
        </div>
        
        <div class="col-md-4">
          <label for="billhead" style="font-size:15px;color: green;">Bill No:</label>
          <input type="text" placeholder="" name="" id="bill-no" style="width:50%;">
          <button type="submit"><i class="fa fa-search" id="bill-search"></i></button>
          <br>
          <label for="barcode" style="font-size:30px; color: red; font-weight: bold;">BarCode No:</label>
          <input type="text" id="barcode" name="barcode" style="width:50%;">
        </div>
        
      </div>
    </div>



  
<div class="row">
  <div class="col-md-12">
    <div class="tab">
      <div class="billing" style="height: 100%">
        <!-- Start Heading 3 Images -->
        
      </div>
      <div class="row" id="chi">
        <div class="col-md-12">
             <div class="card" style="border: 2px solid black; height: 65%; max-height:300px; overflow-y:scroll">
            <div class="plcbill" id="print_area">
              <div class="card" style="display: flex;">
                <table
                  class="table table-borderless"
                  id="bill-items"
                  style="width: 100%"
                >
                  <thead>
                    <tr>
                      <th style="background-color:rgb(13, 13, 72);color: #fff;font-weight: bold;">Sl.No</th>
                      <th style="background-color:rgb(13, 13, 72);color: #fff;font-weight: bold;">BarCode</th>
                      <th style="background-color:rgb(13, 13, 72);color: #fff;font-weight: bold;">Product Description</th>
                      <th style="background-color:rgb(13, 13, 72);color: #fff;font-weight: bold;">Article No</th>
                      <th style="background-color:rgb(13, 13, 72);color: #fff;font-weight: bold;">Hsn No</th>
                      <th style="background-color:rgb(13, 13, 72);color: #fff;font-weight: bold;">Size</th>
                      <th style="background-color:rgb(13, 13, 72);color: #fff;font-weight: bold;">Qty</th>
                      <th style="background-color:rgb(13, 13, 72);color: #fff;font-weight: bold;">Free</th>
                      <th style="background-color:rgb(13, 13, 72);color: #fff;font-weight: bold;">P.Price</th>
                      <th style="background-color:rgb(13, 13, 72);color: #fff;font-weight: bold;">MRP</th>
                      <th style="background-color:rgb(13, 13, 72);color: #fff;font-weight: bold;">Tax%</th>
                      <th style="background-color:rgb(13, 13, 72);color: #fff;font-weight: bold;">Disc1%</th>
                      <th style="background-color:rgb(13, 13, 72);color: #fff;font-weight: bold;">D Amt1</th>
                      <th style="background-color:rgb(13, 13, 72);color: #fff;font-weight: bold;">Disc2%</th>
                      <th style="background-color:rgb(13, 13, 72);color: #fff;font-weight: bold;">D Amt2</th>
                      <th style="background-color:rgb(13, 13, 72);color: #fff;font-weight: bold;">L Cost</th>
                      <th style="background-color:rgb(13, 13, 72);color: #fff;font-weight: bold;">Tot Cost</th>
                      <th style="background-color:rgb(13, 13, 72);color: #fff;font-weight: bold;">S.Price</th>
                      <th style="background-color:rgb(13, 13, 72);color: #fff;font-weight: bold;">Total</th>
                      <th style="background-color:rgb(13, 13, 72);color: #fff;font-weight: bold;">Marg%</th>                     
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>


        <div class="row" style="margin-top:-40px;">
          <div class="col-md-8"></div>
          <div class="col-md-4">
            <div class="total">
                <div class="row">
                  <div class="col-md-4"></div>
                  <div class="col-md-4">
                    <label for="" style="font-size:12px;">Cess Amt</label>
                     <input type="text" placeholder="" name="" style="width:40%;"/>
                         <br />
                         <label for="" style="font-size:12px;">TCS Amt</label>
                     <input type="text" placeholder="" name="" style="width:40%;"/>
                         <br />
                         <label for="" style="font-size:12px;">O Charges</label>
                     <input type="text" placeholder="" name="" style="width:40%;"/>
                         <br />
                         <label for="" style="font-size:12px;">Other Disc</label>
                     <input type="text" placeholder="" name="" style="width:40%;"/>
                         <br />
                         <label for="" style="font-size:12px;">Round Off</label>
                     <input type="text" placeholder="" name="" style="width:40%;"/>
                         <br />
                         
                  </div>
                  <div class="col-md-4">
                    <label for="" style="font-size:12px;">Total Amt</label>
                    <input type="text" placeholder="" name="" style="width:40%;"/>
                        <br />
                     <label for="" style="font-size:12px;">Addl Disc</label>
                     <input type="text" placeholder="" name="" style="width:40%;"/>
                        <br /> 
                        <label for="" style="font-size:12px;">SGST Amt</label>
                      <input type="text" placeholder="" name="" style="width:40%;"/>
                        <br />
                        <label for="" style="font-size:12px;">CGST Amt</label>
                    <input type="text" placeholder="" name="" style="width:40%;"/>
                        <br />  
                        <label for="" style="font-size:12px;">IGST Amt</label>
                    <input type="text" placeholder="" name="" style="width:40%;"/>
                        
                 </div>
                 
                </div>
                <label for="totalamount" style="color: red; font-size:15px;margin-left: 40%;"><u>Grand Total</u></label>
                     <input type="text" placeholder="" name="grandtotal" style="width:30%;"/> 
              
            </div>

          </div>
        </div>
        <div class="row">
        <div class="btn1" style="margin-left:7%;">
          <button
            style="
              color: aliceblue;
              width: 150px;
              height: 50px;
              font-weight: 900;
            "
            class="btn btn-secondary" 
          >
          <i class="fa-regular fa-plus"></i>
          Submit
          </button>
          <a href="#"
            ><button
              style="
                color: aliceblue;
                width: 150px;
                height: 50px;
                font-weight: 900;
              "
              class="btn btn-success"
              id="generate-bill"
            >
            <i class="fa-duotone fa-money-bill-1-wave"></i>
              Update
            </button></a
          >
          <button
            id="hold-save"
            style="width: 150px; height: 50px; font-weight: 900"
            class="btn btn-primary"
          >
          <i class="fa-solid fa-floppy-disk"></i>
            Delete
          </button>
          <button
            style="
              color: aliceblue;
              width: 150px;
              height: 50px;
              font-weight: 900;
            "
            class="btn btn-info"
          >
          <i class="fa-sharp fa-solid fa-arrow-rotate-left"></i>
            Print
          </button>
          <button
            style="
              color: aliceblue;
              width: 150px;
              height: 50px;
              font-weight: 900;
            "
            id="clr-btn"
            class="btn btn-warning"
          >
          <i class="fa fa-trash"></i>
            Clear
          </button>
          <a href="{% url 'exit_bill' %}"
            >
            <button
              style="
                color: aliceblue;
                width: 150px;
                height: 50px;
                font-weight: 900;
              "
              class="btn btn-danger"
            >
            <i class="fa-sharp fa-solid fa-circle-xmark"></i>
              Exit
            </button></a
          >
        </div>
        
        
        </div>
        
        
      </div>
    </div>
  </div>
</div>
    
    <script>
      const debounce = function (cb, timeout = 1000) {
        let refID;
        return function () {
          const self = this;
          const args = arguments;
          clearTimeout(refID);
          refID = setTimeout(() => cb.apply(self, args), timeout);
        };
      };

      $(document).ready(function () {
        const key_name_pair = {
          pur_bill_no: "",
          barcode: "",
          product_description: "",
          article_no: "",
          hsn_no: "",
          size: "", 
          qty: "", 
          free: "", 
          p_price: "", 
          mrp: "", 
          tax: "", 
          cess: "", 
          disc1: "", 
          d_Amt1: "", 
          disc2: "", 
          d_Amt2: "", 
          l_Cost: "", 
          tot_Cost: "", 
          s_Price: "", 
          total: "", 
          marg: "",
        };

        const customer_key_name_pair = {
          trans_date: "", 
          gstin: "", 
          pur_bill_no: "", 
          bill_type: "", 
          supplier_name: "", 
          total_qty: "", 
          gross_amt: "", 
          disc_amt: "", 
          gst_amt: "", 
          tcs: "", 
          o_charge: "",
          o_disc: "", 
          grand_total: "", 
        };

        function addProductToBill(fields) {
          const tbody = $("#bill-items tbody");

          if (!fields.barcode) return;

          let tr = $("<tr />").data("data", fields);

          // $(tr).append($("<td />").text(fields.sl_no));
          $(tr).append($("<td />").html(`
            <div>
              <input type="number" value="${fields.slno}" class="slno-field>"
            </div>
          `));
          $(tr).append($("<td />").text(fields.barcode));
          $(tr).append($("<td />").html(`
            <div>
              <input type="text" value="${fields.product_name}" class="product-description-field">
            </div>
          `));
          $(tr).append($("<td />").html(`
            <div>
              <input type="number" value="${fields.article_no}" class="article-no-field">
            </div>
          `));
          $(tr).append($("<td />").html(`
            <div>
              <input type="number" value="${fields.hsn_no}" class="hsn-no-field">
            </div>
          `));
          $(tr).append($("<td />").html(`
            <div>
              <input type="text" value="${fields.size}" class="size-field">
            </div>
          `));
          $(tr).append($("<td />").html(`
            <div>
              <input type="number" value="${fields.qty}" class="qty-field">
            </div>
          `));
          $(tr).append($("<td />").html(`
            <div>
              <input type="number" value="${fields.free}" class="free-field">
            </div>
          `));
          $(tr).append($("<td />").html(`
            <div>
              <input type="number" value="${fields.p_Price}" class="p-Price-field">
            </div>
          `));
          $(tr).append($("<td />").html(`
            <div>
              <input type="number" value="${fields.mrp}" class="mrp-field">
            </div>
          `));
          $(tr).append($("<td />").html(`
            <div>
              <input type="number" value="${fields.tax}" class="tax-field">
            </div>
          `));
          // $(tr).append($("<td /").html(`
          // <div>
          //   <input type="number" value="${fields.cess}" class="cess-field">
          // </div>
          // `));
          $(tr).append($("<td />").html(`
            <div>
              <input type="number" value="${fields.disc1}" class="disc1-field">
            </div>
          `));
          $(tr).append($("<td />").html(`
            <div>
              <input type="number" value="${fields.d_Amt1}" class="d_Amt1-field">
            </div>
          `));
          $(tr).append($("<td />").html(`
            <div>
              <input type="number" value="${fields.disc2}" class="disc2-field">
            </div>
          `));
          $(tr).append($("<td />").html(`
            <div>
              <input type="number" value="${fields.d_Amt2}" class="d_Amt2-field">
            </div>
          `));
          // $(tr).append($("<td /").html(`
          //   <div>
          //     <input type="number" value="${fields.l_Cost}" class="l_cost-field">
          //   </div>
          // `));
          $(tr).append($("<td />").html(`
            <div>
              <input type="number" value="${fields.tot_Cost}" class="tot-cost-field">
            </div>
          `));
          $(tr).append($("<td />").html(`
            <div>
              <input type="number" value="${fields.s_Price}" class="s_Price-field">
            </div>
          `));
          $(tr).append($("<td />").html(`
            <div>
              <input type="number" value="${fields.total}" class="total-field">
            </div>
          `));
          $(tr).append($("<td />").html(`
            <div>
              <input type="number" value="${fields.marg}" class="marg-field">
            </div>
          `));

          $(tbody).append(tr);

          calculateSubTotal();
          calculateTax();
        }

        function getBillData() {
          const name = $('input[name="custname"]').val();
          const email = $('input[name="custemail"]').val();
          const phone = $('input[name="custphone"]').val();

          const tbody = $("#bill-items tbody");
          let products = [];
          $(tbody)
            .children("tr")
            .each(function (i, tr) {
              products.push($(tr).data("data"));
            });

          return { name, email, phone, products };
        }

        function calculateSubTotal() {
          const items = $("#bill-items tbody tr");
          let total = 0;

          $(items).each(function (i, item) {
            let { quantity, price } = $(item).data("data");
            total += price * quantity;
          });
          $('[name="subtotal"]').val(total).attr("readonly", true);
          $('[name="grandtotal"]').val(total).attr("readonly", true);
        }

        function calculateTax() {
          const items = $("#bill-items tbody tr");
          let tax = 0;

          $(items).each(function (i, item) {
            let { quantity, taxamount } = $(item).data("data");
            tax += taxamount * quantity;
          });
          $('[name="totaltax"]').val(tax).attr("readonly", true);
        }

        function addToBill () {
          let fields = {
            barcode: "",
            product_name: "",
            price: "",
            category: "",
            brand: "",
            quantity: "",
            taxamount: "",
          };

          for (let field in fields) {
            fields[field] = $(`[name="${field}"]`).val();
            $(`[name="${field}"]`).val("");
          }

          addProductToBill(fields);
        }
        
        $("#barcode").on(
          "input",
          debounce(function () {
            let barcode = $(this).val();
            if (barcode) {
              $.ajax({
                url: "/api/product",
                method: "POST",
                data: {
                  csrfmiddlewaretoken: "{{ csrf_token }}",
                  barcode,
                },
                success: function (resp) {
                  const data = resp.data[0];
                  if (!data) return;

                  for (let key in key_name_pair) {
                    $(`[name="${key_name_pair[key]}"]`).val(data[key]);
                  }

                  $(`[name="quantity"]`).val(1);

                  addToBill();
                },
              });
            }
          })
        );

        $('#apply-coupon').click(function() {
          const code = $('[name="coupon"]').val()
          $.ajax({
            url: '/api/check_coupon',
            data: {
              code,
              csrfmiddlewaretoken: "{{ csrf_token }}",
            },
            success: function(data) {
              if(data.valid) {
                $('[name="coupon"]').data('code', data.code)
              } else {
                // TODO: show invalid code error message
              }
              
            }
          })
        })

        $("#add-btn").click(addToBill);

        $('input[name="custphone"]').on(
          "input",
          debounce(function () {
            let phone = $(this).val();
            if (phone) {
              $.ajax({
                url: "/api/customer",
                method: "POST",
                data: {
                  csrfmiddlewaretoken: "{{ csrf_token }}",
                  phone,
                },
                success: function (resp) {
                  const data = resp.data[0];
                  if (!data) {
                    $('input[name="custphone"]').val(phone);
                    return;
                  }

                  for (let key in customer_key_name_pair) {
                    $(`[name="${customer_key_name_pair[key]}"]`).val(data[key]);
                  }
                },
              });
            }
          })
        );

        $('input[name="custname"]').change(function () {
          $('input[name="custname"]').val($(this).val());
        });

        $('input[name="custemail"]').change(function () {
          $('input[name="custemail"]').val($(this).val());
        });

        $("#hold-save").click(function () {
          let data = getBillData();
          data.hold = true;

          $.ajax({
            url: "/api/bill",
            method: "POST",
            data: {
              csrfmiddlewaretoken: "{{ csrf_token }}",
              data: JSON.stringify(data),
            },
            success: function (data) {
              alert(data.cart_id);
            },
          });
        });

        $("#bill-search").click(function () {
          let cart_id = $("#bill-no").val();
          if (!cart_id.trim()) return;

          $.ajax({
            url: "/api/bill",
            method: "GET",
            data: {
              csrfmiddlewaretoken: "{{ csrf_token }}",
              data: cart_id,
            },
            success: function (data) {
              const { cart_id, customer, products } = data;

              $('[name="custphone"]').val(customer.phone);
              $('[name="custname"]').val(customer.name);
              $('[name="custemail"]').val(customer.email);

              for (let product of products) {
                let fields = {
                  barcode: product.barcode,
                  product_name: product.title,
                  price: product.discounted_price,
                  category: product.category,
                  brand: product.brand,
                  quantity: product.quantity,
                };

                addProductToBill(fields);
              }
            },
          });
        });

        $("#clr-btn").click(function () {
          $("input").val("");
          $("#bill-items tbody tr").remove();
        });

        $("#generate-bill").click(function (e) {
          e.preventDefault();
          let data = getBillData();
          data.hold = false;
          data.coupon_code = $('[name="coupon"]').data('code')

          $.ajax({
            url: "/api/bill",
            method: "POST",
            data: {
              csrfmiddlewaretoken: "{{ csrf_token }}",
              data: JSON.stringify(data),
            },
            success: function (data) {
              location.href = "{% url 'demo' %}?cart_id=" + data.cart_id;
            },
          });
        });

        $("#print-btn").click(function () {
          window.print();
        });
      });
    </script>

  </body>
</html>
